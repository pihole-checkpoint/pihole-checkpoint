{% extends "backup/base.html" %}

{% block title %}Settings - Pi-hole Checkpoint{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-gear"></i> Settings</h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Pi-hole Connection Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-wifi"></i> Pi-hole Connection</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Connection settings are configured via environment variables.
                </p>
                <table class="table table-sm mb-3">
                    <tbody>
                        <tr>
                            <th style="width: 150px;">URL</th>
                            <td>
                                {% if credential_status.url %}
                                <code>{{ credential_status.url }}</code>
                                {% else %}
                                <span class="text-danger"><i class="bi bi-x-circle"></i> Not configured</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Password</th>
                            <td>
                                {% if credential_status.has_password %}
                                <span class="text-success"><i class="bi bi-check-circle"></i> Configured</span>
                                {% else %}
                                <span class="text-danger"><i class="bi bi-x-circle"></i> Not set</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>SSL Verification</th>
                            <td>
                                {% if credential_status.verify_ssl %}
                                <span class="text-success"><i class="bi bi-shield-check"></i> Enabled</span>
                                {% else %}
                                <span class="text-warning"><i class="bi bi-shield-x"></i> Disabled</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-outline-secondary" onclick="testConnection()" {% if not credential_status.url or not credential_status.has_password %}disabled{% endif %}>
                    <i class="bi bi-wifi"></i> Test Connection
                </button>
                {% if not credential_status.url or not credential_status.has_password %}
                <div class="form-text text-danger mt-2">
                    Set PIHOLE_URL and PIHOLE_PASSWORD environment variables to enable connection.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Backup Schedule Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Backup Schedule</h5>
            </div>
            <div class="card-body">
                <form method="post" id="configForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="id_name" class="form-label">Name</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">A friendly name for this backup configuration</div>
                    </div>

                    <hr>

                    <h6 class="mb-3">Schedule</h6>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="id_backup_frequency" class="form-label">Frequency</label>
                            {{ form.backup_frequency }}
                        </div>
                        <div class="col-md-4">
                            <label for="id_backup_time" class="form-label">Time</label>
                            {{ form.backup_time }}
                            <div class="form-text">For daily/weekly</div>
                        </div>
                        <div class="col-md-4">
                            <label for="id_backup_day" class="form-label">Day</label>
                            {{ form.backup_day }}
                            <div class="form-text">For weekly</div>
                        </div>
                    </div>

                    <hr>

                    <h6 class="mb-3">Retention Policy</h6>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_max_backups" class="form-label">Maximum Backups</label>
                            {{ form.max_backups }}
                            <div class="form-text">Keep this many backups (0 = unlimited)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="id_max_age_days" class="form-label">Maximum Age (days)</label>
                            {{ form.max_age_days }}
                            <div class="form-text">Delete backups older than this (0 = no limit)</div>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_active }}
                            <label class="form-check-label" for="id_is_active">Enable Scheduled Backups</label>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Help</h5>
            </div>
            <div class="card-body">
                <h6>Environment Variables</h6>
                <p class="small">Pi-hole connection settings are configured via environment variables in your <code>.env</code> file or Docker Compose:</p>
                <ul class="small">
                    <li><code>PIHOLE_URL</code> - Pi-hole URL (e.g., https://192.168.1.100)</li>
                    <li><code>PIHOLE_PASSWORD</code> - Pi-hole admin password</li>
                    <li><code>PIHOLE_VERIFY_SSL</code> - Enable SSL verification (default: false)</li>
                </ul>

                <h6>Backup Frequency</h6>
                <ul class="small">
                    <li><strong>Hourly:</strong> Every hour</li>
                    <li><strong>Daily:</strong> Once per day at specified time</li>
                    <li><strong>Weekly:</strong> Once per week on specified day/time</li>
                </ul>

                <h6>Retention Policy</h6>
                <p class="small">Old backups are automatically deleted based on count and age limits. Set to 0 to disable a limit.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function testConnection() {
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';

    try {
        const response = await fetch('{% url "test_connection" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: '{}'
        });
        const data = await response.json();

        if (data.success) {
            showToast(`Connection successful! Pi-hole v${data.version || 'unknown'}`, 'success');
        } else {
            showToast(data.error || 'Connection failed', 'danger');
        }
    } catch (error) {
        showToast('Error testing connection: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}
</script>
{% endblock %}
